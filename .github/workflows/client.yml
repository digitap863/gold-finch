# name: client

# on:
#   push:
#     branches: [ "main" ]

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#     - uses: actions/checkout@v3

#     - name: Install Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '20.x'
#         cache: 'npm'
#         cache-dependency-path: package-lock.json

#     - name: Install dependencies
#       run: npm install

#     - name: Run build task
#       run: npm run build --if-present

#     - name: Deploy to Server
#       uses: easingthemes/ssh-deploy@main
#       env:
#         SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
#         ARGS: "-rlgoDzvc -i --delete"
#         SOURCE: "./"
#         REMOTE_HOST: ${{ secrets.HOST }}
#         REMOTE_USER: ${{ secrets.USERNAME }}
#         REMOTE_PORT: ${{ secrets.SSH_PORT || 22 }}  # Add custom SSH port if needed
#         TARGET: "/var/www/gold-finch"
#         EXCLUDE: "/node_modules/, /.git/"

#     - name: Restart PM2
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.HOST }}
#         username: ${{ secrets.USERNAME }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           cd /var/www/gold-finch
#           npm ci --only=production || npm install --production
#           pm2 restart gold-finch || pm2 start npm --name "gold-finch" -- start -- -p 3007





name: Deploy Gold Finch

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      env:
        MONGO_URI: ${{ secrets.MONGO_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
        CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
        NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        SMS_GATEWAY_USERNAME: ${{ secrets.SMS_GATEWAY_USERNAME }}
        SMS_GATEWAY_PASSWORD: ${{ secrets.SMS_GATEWAY_PASSWORD }}
        SMS_GATEWAY_PE_ID: ${{ secrets.SMS_GATEWAY_PE_ID }}
        SMS_GATEWAY_TEMPLATE_ID_LOGIN: ${{ secrets.SMS_GATEWAY_TEMPLATE_ID_LOGIN }}
        SMS_GATEWAY_TEMPLATE_ID_PASSWORD: ${{ secrets.SMS_GATEWAY_TEMPLATE_ID_PASSWORD }}
        SMS_GATEWAY_API_URL: ${{ secrets.SMS_GATEWAY_API_URL }}
      run: npm run build

    - name: Deploy to Server
      uses: easingthemes/ssh-deploy@main
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        ARGS: "-rlgoDzvc -i --delete"
        SOURCE: "./"
        REMOTE_HOST: ${{ secrets.HOST }}
        REMOTE_USER: ${{ secrets.USERNAME }}
        TARGET: "/var/www/gold-finch"
        EXCLUDE: "/node_modules/, /.git/, /.next/cache/, .env, .env.local, .env.production"

    - name: Setup Environment and Restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/gold-finch
          
          cat > .env.production << 'EOF'
          PORT=3007
          NODE_ENV=production
          MONGO_URI=${{ secrets.MONGO_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
          SMS_GATEWAY_USERNAME=${{ secrets.SMS_GATEWAY_USERNAME }}
          SMS_GATEWAY_PASSWORD=${{ secrets.SMS_GATEWAY_PASSWORD }}
          SMS_GATEWAY_PE_ID=${{ secrets.SMS_GATEWAY_PE_ID }}
          SMS_GATEWAY_TEMPLATE_ID_LOGIN=${{ secrets.SMS_GATEWAY_TEMPLATE_ID_LOGIN }}
          SMS_GATEWAY_TEMPLATE_ID_PASSWORD=${{ secrets.SMS_GATEWAY_TEMPLATE_ID_PASSWORD }}
          SMS_GATEWAY_API_URL=${{ secrets.SMS_GATEWAY_API_URL }}
          EOF
          
          npm ci --omit=dev || npm install --production
          
          pm2 delete gold-finch 2>/dev/null || true
          PORT=3007 pm2 start npm --name "gold-finch" -- start
          pm2 save